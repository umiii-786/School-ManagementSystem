<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- /* <script src="https://cdn.tailwindcss.com/3.4.16"></script>*/ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <title>Document</title>

    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        .main-container {
            width: 100%;
            height: 86vh;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
            margin-bottom: 12px;
            line-height: 1.5;
            position: relative;
            padding: 14px;
            font-size: 15px;
        }

        .user-bubble {
            background-color: var(--tableColor);
            border-radius: 18px 18px 0 18px;
            align-self: flex-end;
        }

        .ai-bubble {
            background-color: white;
            border-radius: 18px 18px 18px 0;
            align-self: flex-start;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            align-self: flex-start;
            padding: 8px;
            margin-top: 0.5rem;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: #930000;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: inline-block;
            margin-right: 5px;
        }

        .suggestion-pill {
            background-color: #1A1A1A;
            border: 1px solid #3A3A3A;
            border-radius: 20px;
            padding: 8px 16px;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .suggestion-pill:hover {
            background-color: #2A2A2A;
            border-color: #930000;
        }





        .chat-container {
            width: 75%;
            height: 100%;
            box-shadow: var(--sidebutton-boxshadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .side-panel {
            width: 20%;
            height: 100%;
            box-shadow: var(--sidebutton-boxshadow);
            border-left: 1px solid #2A2A2A;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;

        }

        .side-panel.collapsed {
            transform: translateX(100%);
        }

        .feature-button {
            background-color: #1A1A1A;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .feature-button:hover {
            background-color: #2A2A2A;
            transform: translateY(-2px);
        }






        #chat-messages {
            display: flex;
            flex-direction: column;
        }

        .cover_of_chat_messages {

            overflow-y: auto;
            height: 75%;
            width: 90%;
            margin-bottom: 10px;
        }

        .h1 {
            color: var(--tableColor);
            margin: 20px 0px;
            font-size: 30px;
            width: 90%;
            text-align: center;
            font-weight: bolder;
        }

        .input_box {
            width: 90%;
        }

        .chat-input {
            width: 85%;
            border-radius: 8px;
            padding: 8px;
            margin-right: 10px;
            background: transparent;
            border: 1px solid rgb(133, 133, 133);
            color: var(--text-color);
            margin-bottom: 10px;
        }

        nav {
            height: 10vh !important;
        }

        #send-message {
            padding: 10px;
            background: #930000;
            ;
            color: white;
            border-radius: 6px;
        }

        .previousChats {
            height: 100%;
            border-top: 1px solid gray;
            width: 90%;
            overflow-y: auto;
        }

        .eachChat {
            margin: 10px 0px;
            padding: 3px 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .eachChat:hover {
            background-color: rgb(239 227 227);
        }

        .previous_chat_heading {
            color: var(--tableColor);
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .emergency-button {
            padding: 12px;
            margin: 20px 0px;
            transition: all 0.3s ease;
            width: 90%;

        }

        .emergency-button:hover {
            background-color: #b30000;
            transform: translateY(-2px);
        }

        .btn {
            background-color: #930000;
            color: white;
            border-radius: 8px;
            border: 1px solid red;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <%- include('../includes/navbar.ejs') %>
        <%- include('../includes/alerts.ejs') %>
            <!-- Header -->

            <!-- Main Content Area -->
            <div class="main-container">

                <div id="side-panel" class="side-panel">
                    <button class="emergency-button btn">
                        <i class="ri-add-line ri-lg" style="margin-right: 10px;"></i>
                        <span>Create Chat</span>
                    </button>

                    <h4 class="previous_chat_heading">Here is Your Previous Chat</h4>

                    <div class="previousChats">
                        <div class="eachChat">
                            Lorem ipsum dolor sit ....
                        </div>




                    </div>


                </div>



                <div class="chat-container">


                    <h1 class="h1">Welcome to the Quest-GPT</h1>
                    <!-- Chat Area -->
                    <!-- Chat Messages -->
                    <div class="cover_of_chat_messages">


                        <div id="chat-messages">
                            <!-- Welcome Message -->
                            <div class="chat-bubble ai-bubble">
                                <p>Hey Questians, Welcome to the QUEST-GPT</p>
                            </div>

                            <!-- AI Response -->

                            <!-- User Message -->




                            <!-- Typing Indicator -->

                        </div>
                        <div class="chat-bubble" id="typing-indicator">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestion Pills -->

                    <!-- Chat Input Area -->
                    <div class="input_box">
                        <input type="text" id="message-input" class="chat-input " placeholder="Type your message...">

                        <button id="send-message" class="btn">
                            Send <i class="ri-send-plane-fill ri-lg"></i>
                        </button>
                    </div>
                </div>


            </div>
            <!-- Side Panel -->

            </div>

            <script>




                let current_conversation = []
                const pageHideListener = (event) => {
                    //Send something to back end
                    console.log(current_conversation)
                    console.log(current_conversation.length)
                    alert('page changed ')

                    alert(`length is ${current_conversation.length}`)
                    if (current_conversation.length >= 2) {
                        alert('request done')
                        const data = JSON.stringify(current_conversation);
                        navigator.sendBeacon('http://127.0.0.1:8000/pageChange', new Blob([data], { type: 'application/json' }));
                        /* fetch('http://127.0.0.1:8000/pageChange', {
                                  method: "POST",
                                  body:JSON.stringify(current_conversation)
                         }) */
                    }

                };

                window.addEventListener("pagehide", pageHideListener);

                const messageInput = document.getElementById('message-input');
                const sendButton = document.getElementById('send-message');
                const chatMessages = document.getElementById('chat-messages');
                const typingIndicator = document.querySelector('.typing-indicator');
                const suggestionPills = document.querySelectorAll('.suggestion-pill');

                function createMessageBubble(message, isUser = false) {
                    const bubble = document.createElement('div');
                    bubble.className = `chat-bubble ${isUser ? 'user-bubble ' : 'ai-bubble'}`;
                    const content = ` <p>${message}</p>`;
                    bubble.innerHTML = content;
                    return bubble;
                }


                async function sendMessage() {
                    const message = messageInput.value.trim();
                    if (message) {
                        // Add user message
                        current_conversation.push({ 'user': message })
                        const userBubble = createMessageBubble(message, true);
                        chatMessages.appendChild(userBubble);
                        messageInput.value = '';
                        typingIndicator.style.display = 'flex'
                        let result = ''
                        try {
                            const response = await fetch('http://127.0.0.1:8000/', {
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                method: "POST",
                                body: JSON.stringify({ 'question': message })
                            })
                            const data = await response.json()
                            result = data['answer']
                        }
                        catch (expection) {
                            result = 'SomeThing Went Wrong with Server'
                        }
                        console.log(result)
                        current_conversation.push({ 'ai': result })
                        const aiBubble = createMessageBubble(result, false);
                        chatMessages.appendChild(aiBubble);
                        // Scroll to bottom again
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        typingIndicator.style.display = 'none'
                        console.log(current_conversation)
                        console.log(current_conversation.length)

                    }
                }
                // Send message on button click
                sendButton.addEventListener('click', sendMessage);
                // Send message on Enter key
                messageInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                // Handle suggestion pills

            </script>
</body>

</html>